<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Double Pendulum: C++ vs Python (Wasm)</title>

    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <script src="cpp_solver.js"></script>
</head>

<body style="background-color: #111; color: white; font-family: sans-serif; padding: 20px;">

    <h1>Double Pendulum Simulation</h1>
    <p>
        Red: Naive Runge-Kutta 4 (C++) | Cyan: Adaptive-Step LSODA (Python, SciPy) | Magenta: Adaptive-Step RK4 (C++)
    </p>
    <div id="status">Status: Loading Python & C++...</div>
    <button id="reset-btn" onclick="resetSimulation()"
        style="padding: 10px 20px; background: #444; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">
        Restart Simulation
    </button>

    <div id="plot-div"></div>

    <py-config>
        packages = ["numpy", "scipy", "matplotlib", "sympy"]
    </py-config>

    <script>
        let cppModule = null;

        async function resetSimulation() {
            const status = document.getElementById("status");
            const btn = document.getElementById("reset-btn");
            btn.disabled = true;
            status.innerText = "Status: Resetting...";

            // Clear data so Python waits
            delete window.cppData;
            delete window.cppDataAdaptive;

            // Re-run C++ Simulation
            if (!cppModule) {
                cppModule = await createCppSolver();
            } else {
                // If module exists, call the main function exported by Emscripten
                cppModule._main();
            }

            // Read the file from C++ memory
            console.log("Module:", cppModule);
            if (!cppModule.FS) {
                console.error("Module.FS is undefined!");
                status.innerText = "Error: Module.FS is undefined";
                btn.disabled = false;
                return;
            }
            const csvContent = cppModule.FS.readFile('pendulum.csv', { encoding: 'utf8' });
            const csvAdaptiveContent = cppModule.FS.readFile('adaptive_step_size_pendulum.csv', { encoding: 'utf8' });

            // Send this data to PyScript's Python environment
            window.cppData = csvContent;
            window.cppDataAdaptive = csvAdaptiveContent;

            status.innerText = "Status: C++ Done. Python taking over...";
            btn.disabled = false;
        }

        // Run immediately on load
        resetSimulation();
    </script>
    <py-script src="./main.py"></py-script>
</body>

</html>