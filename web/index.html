<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Double Pendulum: C++ vs Python (Wasm)</title>

    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <script src="cpp_solver.js"></script>
</head>

<body style="background-color: #111; color: white; font-family: sans-serif; padding: 20px;">

    <h1>Double Pendulum Simulation</h1>
    <p>
        Red: Naive Runge-Kutta 4 (C++) | Cyan: Adaptive-Step LSODA (Python, SciPy) | Magenta: Adaptive-Step Runge-Kutta
        4 (C++)
    </p>
    <div id="status">Status: Loading Python & C++...</div>
    <button py-click="reset_simulation" id="reset-btn" style="padding: 10px 20px; cursor: pointer;">
        Reset Simulation
    </button>
    <div id="plot-div"></div>

    <py-config>
        packages = ["numpy", "scipy", "matplotlib", "sympy"]
    </py-config>

    <script>
        let module;
        async function runCppAndTransferFile() {
            const status = document.getElementById("status");

            // Clear old data so Python knows to wait for the new simulation
            delete window.cppData;
            delete window.cppDataAdaptive;

            if (!module) {
                module = await createCppSolver();
            } else {
                module._main(); // Re-run C++ main
            }

            status.innerText = "Status: Running C++ Simulation...";

            // 1. Initialize C++ Wasm
            // const module = await createCppSolver();

            // 2. The main() in C++ runs automatically upon init in this config, 
            // creating 'pendulum.csv' in the C++ virtual memory.

            // 3. Read the file from C++ memory
            console.log("Module:", module);
            if (!module.FS) {
                console.error("Module.FS is undefined!");
                status.innerText = "Error: Module.FS is undefined";
                return;
            }
            const csvContent = module.FS.readFile('pendulum.csv', { encoding: 'utf8' });
            const csvAdaptiveContent = module.FS.readFile('adaptive_step_size_pendulum.csv', { encoding: 'utf8' });

            // 4. Send this data to PyScript's Python environment
            window.cppData = csvContent;
            window.cppDataAdaptive = csvAdaptiveContent;

            status.innerText = "Status: C++ Done. Solving Python Equations...";
        }

        // Run immediately
        runCppAndTransferFile();
    </script>
    <py-script src="./main.py"></py-script>
</body>

</html>